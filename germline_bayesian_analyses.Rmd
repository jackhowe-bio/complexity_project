---
title: "Single-celled bottlenecks, germlines and the evolution of complex multi-cellularity"
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float: yes
    fig_caption: TRUE
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_float: yes
    fig_caption: yes
---



# Pre-amble
## load packages
```{r packages}
library(ape)
library(ggplot2)
library(tidyverse)
library(knitr)
library(brms) #https://rdrr.io/cran/brms/f/vignettes/brms_phylogenetics.Rmd
library(tidybayes)
library(rotl) #see https://cran.r-project.org/web/packages/rotl/vignettes/rotl.html
```

## read in data
```{r data_input}
df<- read.csv('data/germline_data_1.1.csv')
```

## create phylogeny files
```{r phylogeny_creation, message=F, results='hide'}
ResolvedNames <- tnrs_match_names(df$species.updated.rotl, context_name = 'All life') #search for similar names in the 'open tree of life' project (ROTL)
ResolvedNames$IsInTree <- is_in_tree(ResolvedNames$ott_id) #T/F, did the above find a match that can be put in the phylogeny? 
ResolvedNamesInTree<- subset(ResolvedNames, IsInTree==T) #subset to only those where present in the phylogeny

AllTree<- tol_induced_subtree(ResolvedNamesInTree$ott_id, label_format = 'id') #draw the phylogeny

# tree with resolved polytomies:
ResolvedPolytomiesTree<- multi2di(AllTree)

# write to files
write.tree(AllTree, file='data/phylogeny_all.txt') #phylogeny
write.tree(AllTree, file='data/phylogeny_all_res_polytomy.txt') #phylogeny with resolved polytomies
write.csv(ResolvedNames, 'data/phylogeny_species_names.csv') #list of names
write.csv(ResolvedNamesInTree, 'data/phylogeny_species_names_in_tree.csv') #list of names that are present in the tree
```

Preparing the phylogeny data
```{r}
#read in phylogeny
phylo<- ape::read.tree('data/phylogeny_all.txt')
#subset df above with just those that are in the tree (note some missing)
names_in_tree<- read.csv('data/phylogeny_species_names_in_tree.csv')
names_in_tree$ott_id<- paste('ott',names_in_tree$ott_id, sep = '')
#phylo$tip.label %in% names_in_tree$ott_id #to check whether they're all present
names_in_tree<- subset(names_in_tree, names_in_tree$ott_id %in% phylo$tip.label)
#which species in the table are in the tree
df$species.updated.rotl<- tolower(df$species.updated.rotl)
df<- subset(df, tolower(df$species.updated.rotl) %in% tolower(names_in_tree$search_string))
#give them the ids in a column sot hat brms can match it up
df$species_id<- names_in_tree$ott_id
```
Covariance matrix produced using branch lengths of 1 (as in Fisher et al)
```{r}
# set branch lengths to 1 for covariance matrix
phylo_1b <- compute.brlen(phylo, 1)
#create covariance matrix
CovarMatrix <- ape::vcv.phylo(phylo_1b)
```

```{r plot_phylogeny, fig.cap="Simple phylogenetic tree constructed using the Open Tree of Life, needs manually checked for errors"}
#plot phylogeny to check
plot(AllTree, no.margin = TRUE, cex = 0.5, label.offset = 0.5)
```

Change the fission or budding observed column to 'yes' vs 'no' to make sure it is not doing some weird numeric thing
```{r}
df$FissionOrBuddingObserved_Genus_nominal <- ifelse(df$FissionOrBuddingObserved_Genus == 1, 'yes','no')
```

# Analyses 

Conducting Bayesian analyses using BRMS, first without phylogeny included, then including phylogeny. Each analysis contains the code that defines the model, and briefly analyses them-- producing summary stats and figs.

See below for analyses of:

Each analysis uses vague priors, 5 chains, 6,000,000 iterations, 100000 of which are discarded as warm-up, thinned by a factor of 1000.

(Currently use reproductive traits of genus rather than species)

* Phylogenetically naive:
  + Does a single-celled bottleneck correlate with increased cell number? (priors = normal dist, mean of 0, sd of 10)
  + Does a single-celled bottleneck correlate with increased cell types (per cell)? prior(normal(0, 10), "b")
  + Does germline timing correlate with increased cell number?
  + Does germline timing correlate with increased cell types (per cell)?
  
* Phylogenetically informed:
  + Does a single-celled bottleneck correlate with increased cell number?  
  + Does a single-celled bottleneck correlate with increased cell types (per cell)?
  + Does germline timing correlate with increased cell number?
  + Does germline timing correlate with increased cell types (per cell)?

To do: do any of these things need scaled?


## Phylogenetically naive
### Does a single-celled bottleneck correlate with increased cell number?
#### defining the model  
Using simple normally-distributed, relatively non-informative prior

One possibility is that the 0s and 1s are treated as numeric, when they should be categorical, so change to yes/no.

```{r FissionCellNumber}
#fit the model 
fit_fission_cell_num<-
  brm(data = df,
      family=gaussian(), # family of model
      formula = log(cell_number) ~ 0 + FissionOrBuddingObserved_Genus_nominal,  #formula, the 0 means that there are estimates for both clonal and non-clonal, rather than relative to each other
      iter = 6000000, warmup = 100000, chains = 5,thin = 1000, cores = 5, #chain settings
      prior = prior(normal(0, 10), "b"), #defining the priors- for things in 'class b' set this prior. (can also use get_priors() and set_priors() fucncitons) 
      file = 'fits/fit_FissionCellNumber' ) 

#### Assessing model:  
plot(fit_fission_cell_num) #check that chains converged
pp_check(fit_fission_cell_num) #check the predictions
summary(fit_fission_cell_num) #summary of model 
posterior_summary(fit_fission_cell_num, robust = T)
plot(conditional_effects(fit_fission_cell_num, points = TRUE, ask = F)) 

hyp = hypothesis(fit_fission_cell_num,  "FissionOrBuddingObserved_Genus_nominalno > FissionOrBuddingObserved_Genus_nominalyes") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)
```

### Does a single-celled bottleneck correlate with increased cell types (per cell)?
```{r FissionCellType}
#fit the model 
fit_fission_cell_type<-
  brm(data = df,
      family=poisson(),
      formula = cell_types ~ 0 + FissionOrBuddingObserved_Genus_nominal + scale(log(cell_number)),  #formula, the 0 means that there are estimates for both clonal and non-clonal, rather than relative to each other
      iter = 6000000, warmup = 100000, chains = 5,thin = 1000, cores = 5, #chain settings
      prior = prior(normal(0, 10), "b"), #defining the priors- for things in 'class b' set this prior. (can also use get_priors() and set_priors() fucncitons) 
      file = 'fits/fit_FissionCellType' ) 

plot(fit_fission_cell_type) #check that chains converged
pp_check(fit_fission_cell_type) #check the predictions
summary(fit_fission_cell_type) #summary of model 
posterior_summary(fit_fission_cell_type, robust = T)
plot(conditional_effects(fit_fission_cell_type, points = TRUE, ask = F)) 

hyp = hypothesis(fit_fission_cell_type,  "FissionOrBuddingObserved_Genus_nominalno > FissionOrBuddingObserved_Genus_nominalyes") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)
```