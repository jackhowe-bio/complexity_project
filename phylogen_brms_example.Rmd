---
title: "BRMS phylogeny"
output: html_notebook
---
https://cran.r-project.org/web/packages/brms/vignettes/brms_phylogenetics.html

```{r}
library(ape)
library(brms)
```


# A Simple Phylogenetic Model

Assume we have measurements of a phenotype, phen (say the body size), and a cofactor variable (say the temperature of the environment). We prepare the data using the following code.

```{r}

phylo <- ape::read.nexus("https://paul-buerkner.github.io/data/phylo.nex")
data_simple <- read.table(
  "https://paul-buerkner.github.io/data/data_simple.txt", 
  header = TRUE
)
head(data_simple)
```


make a covariance matrix using the phylogenetic tree in the phylo object (loaded in from .nexus file) 
```{r}
A <- ape::vcv.phylo(phylo)
```

## Generate simple brms model

 Phenotype by cofactor, with phylogeny as a random factor. 
 Cov = A means that the species are correlated as specified by the covariance matrix. gr() sets up groups according to the phylo column in the data, with A passed into the function using data2 (fits data that are of different structures)
 
 Don't need priors, but speeds things up

```{r}
model_simple <- brm(
  phen ~ cofactor + (1|gr(phylo, cov = A)), 
  data = data_simple, 
  family = gaussian(), 
  data2 = list(A = A),
  prior = c(
    prior(normal(0, 10), "b"), 
    prior(normal(0, 50), "Intercept"),
    prior(student_t(3, 0, 20), "sd"),
    prior(student_t(3, 0, 20), "sigma")
  ),
  chains = 3, cores = 3
)
```
```{r}
summary(model_simple)
plot(model_simple, N = 2, ask = F)
plot(conditional_effects(model_simple), points = TRUE) 
```
Testing for phylogenetic signal:
standard deviation because of phylo over all variation? Smaller signal -> 0, larger effect of phylogeny -> 1
```{r}
hyp <- "sd_phylo__Intercept^2 / (sd_phylo__Intercept^2 + sigma^2) = 0"
(hyp <- hypothesis(model_simple, hyp, class = NULL))
```



