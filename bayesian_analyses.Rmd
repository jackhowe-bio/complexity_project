---
title: "R Notebook"
output: html_notebook
---


# attempting analysis

## load packages
```{r}
library(ape)
library(ggplot2)
library(tidyverse)
library(brms) #https://rdrr.io/cran/brms/f/vignettes/brms_phylogenetics.Rmd
library(tidybayes)
library(rotl) #see https://cran.r-project.org/web/packages/rotl/vignettes/rotl.html
```

## read in data
```{r}
setwd('/Users/user/Documents/oxford/comparative_data/tidy/analyses/complexity_project')
df<- read.csv('germline_data_1.0.csv')
df[nrow(df),]
```

# trying to recreate Berti's data: does clonality lead to more obligate?

Create simple model, using default undefined priors (flat). Berti used normal distribution?
```{r}
df %>%
  group_by(Obligate_or_facultative) %>%
  count() #summary table just to check that the results kinda fit


#fit the model 
fit_obl<-
  brm(data = df,
      family=bernoulli(link = 'logit'),
      formula = Obligate_or_facultative ~ 0 + clonal, 
      iter = 600000, warmup = 10000, chains = 5,thin = 100, cores = 5,
      prior = prior(normal(0, 10), "b"), file = 'fits/obligate' )

```

Assessing model:
```{r}
plot(fit_obl) #check that chains converged
pp_check(fit_obl) #check the predictions
plot(conditional_effects(fit_obl), points = TRUE) 

summary(fit_obl)
posterior_summary(fit_obl, robust = T) #what are the medians for coefficients? if F, then returns means
```
This is another way of posting from the brms anaysis book online (https://bookdown.org/content/3686/)
```{r}
post <- posterior_samples(fit_obl) #take the posterior samples
post <- #convert them back to probabilities (from log odds)
  post %>% 
  summarise(theta_clonal = exp(b_clonalclonal) / (1 + exp(b_clonalclonal)),
         theta_nonclonal     = exp(b_clonalnonMclonal)/ (1 + exp(b_clonalnonMclonal))) %>% 
  mutate(`theta_clonal - theta_nonclonal` = theta_clonal - theta_nonclonal)

gathered_post <- # pivot table to make plot 
  post %>% 
  select(starts_with("theta")) %>% 
  gather() %>% 
  mutate(key = factor(key, levels = c("theta_clonal", "theta_nonclonal", "theta_clonal - theta_nonclonal")))

gathered_post %>% #draw plot
  ggplot(aes(x = value, y = 0, fill = key)) +
  stat_histinterval(point_interval = mode_hdi, .width = .95,
                    slab_color = "white", outline_bars = T,
                    normalize = "panels") +
  scale_y_continuous(NULL, breaks = NULL) +
  theme_minimal() +
  facet_wrap(~key, scales = 'free') 
```

Testing hypothesis:
```{r}
hyp = hypothesis(fit_obl,  "clonalclonal > clonalnonMclonal") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)
```


# Result 2: number of cells

```{r}
df %>%
  group_by(clonal) %>%
  summarise(cell_mean = mean(log(cell_number), na.rm = T)) #summary table just to check that the results kinda fit
            
prior <- get_prior(log(cell_number) ~ 0 + clonal, family=gaussian(), data = df) #defining what priors we need
```
```{r}
#fit the model 
fit_num<-
  brm(data = df,
      family=gaussian(),
      formula = log(cell_number) ~ 0 + clonal, 
      iter = 600000, warmup = 100000, chains = 5, thin = 100, cores = 5,
      prior = prior(normal(0, 10), "b"), file = 'fits/cell_number' ) # a super simple prior as it leads to slightly quicker runs
```

```{r}
plot(fit_num) #check that chains converged
pp_check(fit_num) #check the predictions
summary(fit_num) #summary of model 
posterior_summary(fit_num, robust = T)
plot(conditional_effects(fit_num), points = TRUE) 
```

testing hypothesis: 
```{r}
hyp = hypothesis(fit_num,  "clonalclonal > clonalnonMclonal") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)
```

# Result 3: number of cell types
```{r}
df %>%
  group_by(clonal) %>%
  summarise(cell_mean = mean(cell_types, na.rm = T)) #summary table just to check that the results kinda fit

prior <- get_prior(cell_types ~ 0 + clonal + cell_number, family=poisson(), data = df) #defining what priors we need
```
fit the model 
```{r}
fit_type<-
  brm(data = df,
      family=poisson(),
      formula = cell_types ~ 0 + clonal + scale(log(cell_number)),
      iter = 600000, warmup = 100000, chains = 5, thin = 1000, cores = 5,
      prior = prior(normal(0, 10), "b"), file = 'fits/cell_type')
```

```{r}
plot(fit_type) #check that chains converged
pp_check(fit_type) #check the predictions
summary(fit_type) #summary of model 
posterior_summary(fit_type, robust = T)
plot(conditional_effects(fit_type), points = TRUE, ask = F) 
```

```{r}
hyp = hypothesis(fit_type,  "clonalclonal > clonalnonMclonal") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)

hyp = hypothesis(fit_type,  "scalelogcell_number = 0") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)
```

# complex vs simple

```{r}

#fit the model 
fit_complex<-
  brm(data = df,
      family=bernoulli(link = 'logit'),
      formula = Simple_or_complex ~ 0 + clonal, 
      iter = 600000, warmup = 10000, chains = 5,thin = 100, cores = 5,
      prior = prior(normal(0, 10), "b"), file = 'fits/fit_complex' )

plot(fit_complex) #check that chains converged
pp_check(fit_complex) #check the predictions
plot(conditional_effects(fit_complex), points = TRUE) 

summary(fit_complex)
posterior_summary(fit_complex, robust = T) #what are the medians for coefficients? if F, then returns means

hyp = hypothesis(fit_complex,  "clonalclonal > clonalnonMclonal") #test hypothesis that there is no difference based on coefficients
hyp
plot(hyp)

```


# with phylogeny included

```{r}
#read in phylogeny
phylo<- ape::read.tree('phylogeny_all.txt')


#subset df above with just those that are in the tree (note some missing)
names_in_tree<- read.csv('phylogeny_species_names_in_tree.csv')
names_in_tree$tip_labels<- paste(gsub(' ', '_', names_in_tree$unique_name), names_in_tree$ott_id, sep = '_ott')

phylo$tip.label

df$species.updated.rotl<- tolower(df$species.updated.rotl)
df<- subset(df, tolower(df$species.updated.rotl) %in% tolower(names_in_tree$search_string))
df<- cbind(df, names_in_tree$tip_labels)
```

produce covariance matrix using branch lengths of 1 (as in Fisher et al)
```{r}
# set branch lengths to 1 for covariance matrix
phylo_1b <- compute.brlen(phylo, 1)
#create covariance matrix
CovarMatrix <- ape::vcv.phylo(phylo_1b)
```

define the phylogenetic model
```{r}
#(1|gr(phylo, cov = A))

fit_obl_phy<-
  brm(data = df,
      family=bernoulli(link = 'logit'),
      formula = Obligate_or_facultative ~ 0 + clonal + (1|gr(CovarMatrix)),
      data2 = list(CovarMatrix = CovarMatrix),
      iter = 6000, warmup = 100, chains = 5,thin = 10, cores = 5,
      prior = prior(normal(0, 10), "b"))
```



