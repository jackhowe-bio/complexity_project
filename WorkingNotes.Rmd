---
title: "*Working Notes:* Single-celled bottlenecks, germlines and the evolution of complex multi-cellularity"
shorttitle: "Notes"
header-includes:
   - \usepackage{lineno}
   - \linenumbers
output: 
  github_document: 
    toc: true
    toc_depth: 4
  bookdown::pdf_document2: 
    toc: true
    toc_depth: 4
  bookdown::html_document2: default
bibliography: "r-references.bib"
#knit: (function(inputFile, encoding){
#  rmarkdown::render(inputFile, encoding = encoding, output_format = "all") })
---

```{r RmdSetup, include = F}
knitr::opts_chunk$set(include = F)
library(ggmcmc)
library(ggpubr)
library(tidyverse)
library(ggthemes)
```

# Data Collection

```{r DataImportPhylogenyConstruction}
getwd()
source('RScripts/DataImportPhylogenyConstruction.R', echo = F)
glimpse(df)
```

## Search strategy

Searches were conducted broadly for literature focussed on reproductive mode and germline development across the tree of life. This included chapters reviews and chapters within textbooks.

As Fisher paper was used for estimates of individual complexity (which in turn used Bell paper as a foundation), narrower searches were conducted for each species/genus from Bell paper on Web of Knowledge and on Google Scholar.

`(ALL = (reproduct* OR sex* OR asex* OR vegetat* OR fissi* OR clonal* OR regenerat* OR rhizo* OR germ-line* OR germline* OR germ line* OR bud* OR fragment* OR parthenogen* OR stolon*)) AND (ALL = TAXON)`

We recorded whether sexual, parthenogenetic/clonal and agametic have been observed as binary values. We did not attempt to capture the relative frequency of different reproductive strategies, as these data do not exist for the majority of species.

Research into reproduction and development is heterogeneous across organisms, and this is necessarily reflected in the required searching effort for different groups: the reproductive biology and development of model organisms such as C. elegans, M. musculus, D. melanogaster, A. thaliana are well known, but in many other groups reproduction may never have been observed. We therefore conducted searches for each species, but if no literature discussing reproductive strategy was observed, then we conducted an additional search at the genus level. This assumes that genera will tend to be relatively similar in their reproductive strategies: this is not always the case. The planarian S. mediterranea, for example, has strictly sexual and strictly asexual strains within even the same species. However, we are focussed on patterns through longer spans of evolution than between individual genera.

Caveats:

-   Sexual organisms contain more cells because they have gonads that asexual organisms lack...  
-   hard to fit algae with gametophyte/sporophyte stages: they have life cycles where some stages can fragment, where some stages can reproduce by spores, parthenogenesis or by sex. If an algae can stay in one loop and reproduce exclusively through parthenogenesis/fragmentation, then counts-- similar to organisms that can fission, but don't always.

## Production of phylogenetic tree

We used a phylogenetic tree to control for non-independence of species based on shared evolutionary history. The tree was constructed within R using the latest evolutionary classifications found on the Tree of Life, AlgaeBase.org, and the World Register of Marine species. The relationships among species were reconstructed by ordering the taxa from Kingdom through to species, and grouping according to these names.

As a comparison, we also constructed a tree using the 'R Tree of Life Project'. These two trees were largely congruent: some larger groups had switched places, but within these groups relationships were predominantly the same. As the Rtol tree dropped X data points from the tree, we used the tree based on the taxa names. Multichotomies within the tree were randomly resolved, before branch lengths were generated as described by [\@grafen1990]. Branches smaller than `r 1e-25` were deleted, and the dichotomies here collapsed to multichotomies. Figure () shows a cophylogeny based on each tree.

# Statistical Analyses

```{r AnalysesImport}
load('RScripts/OptimisingModels.Rdata')
```

```{r Parameters}
iterations<- readRDS('RScripts/iterations.RDS')
burnin<- readRDS('RScripts/burnin.RDS')
thinning <- readRDS('RScripts/thinning.RDS')
n_chains <- readRDS('RScripts/n_chains.RDS')
```

## MCMCglmm parameters

All analyses were conducted in R [\@R-base] using the package MCMCglmm [\@MCMCglmm], while documents were produced using [RMarkdown]. All data and code are accessible at github.

Model parameters were optimised using the first model described in our results, for which we ran a total of `r nrow(testing_args)` MCMCglmm chains of varying lengths (`r (min(testing_args$n_itts))` - `r (max(testing_args$n_itts))` iterations), with varying warm-ups (`r (min(testing_args$n_burn))` - `r (max(testing_args$n_burn))`, and with thinning of either `r (min(testing_args$n_thin))` or `r (max(testing_args$n_thin))` fold, see Figure S\@ref(fig:OptimisationFigure). 
All subsequent models were then fit using the combination of these parameters where the autocorrelation of successive sampled mean and variance were minimal: `r iterations` iterations, a warm-up of `r burnin` iterations and thinning by a factor of `r thinning`. In all fitted models, the autocorrelation was well below the suggested tolerable maximum of 0.1 [\@hadfield?]. For each model, `r n_chains` chains were run which were visually inspected for chain convergence. Convergence was also supported by the Gelman-Rubin [\@Gelman-Rubin] convergence diagnostic, which approximated 1 (\<1.05) in all cases--these are reported in the summary of each model below. 

The four models described in section \@ref(Without Phylogeny) are phylogenetically naive, and treat each species as independent data points. The default priors used for fixed effects, and residual variance prior of V = 1 and nu = 0.002. 

The differences between each level for the fixed effects were calculated at each MCMC iteration to produce a posterior distribution for the difference. Levels are considered statistically significant if the 95% credible interval of this difference distribution did not overlap with 0, and if the proportion of MCMC iterations that were greater or less than 0 was less than 0.05.

The entire analysis, including the parameter optimisation step and creating all output documents, runs in approximately 3hrs 15 mins using a 2020 MacBook Pro running 4 chains in parallel.

```{r OptimisationFigure, include = T, fig.cap = "Autocorrelation of successively sampled mean and variance values from posterior distribution", echo=F}
OptimisingPlot #from OptimisingModels.Rdata
```

## Without Phylogeny

### **Model 1**: Fission vs Cell Number


```{r Model1Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 1: Cell Numbers vs Fission** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between fissioning and non-fissioning organisms, bar represents 90% and 95% credible intervals. "}
Model1 <- readRDS('RScripts/model_outputs/Model1.RDS')

Model1Sol_mcmc<- mcmc.list(lapply(Model1, function(m) m$Sol))
Model1Sol_gg<- ggmcmc::ggs(Model1Sol_mcmc)
Model1Sol_traceplot <- ggmcmc::ggs_traceplot(Model1Sol_gg) + theme_minimal()
Model1Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model1Sol_gg) + theme_minimal()
Model1SolGelman<- gelman.diag(Model1Sol_mcmc,multivariate = FALSE)

NoFission<- Model1Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species0') %>% 
  rename(Fission0 = value) %>% select(-Parameter)

Fission<- Model1Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species1') %>%
  rename(Fission1 = value) %>% select(-Parameter)

Difference<- merge(Fission, NoFission) %>%
  mutate(Difference = Fission1 - Fission0)


HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model1MeanPlot<- ggarrange(Model1Sol_traceplot, Model1Sol_caterpillar, DifPlotM, labels = "AUTO")
Model1MeanPlot

#CKC Processing MCMCglmm models ####

pacman::p_load(devtools)
#CKC - function for processing MCMCglmm models
source_url("https://raw.githubusercontent.com/charliecornwallis/Rfunctions/master/MCMCglmmProc.R")

#Model formula being processed
#MCMCglmm(cell_number ~ FissionOrBuddingObserved_Species-1...

#Extract 1 model
M1<-M1_parallel[1]

#Apply function (description of function terms can be found on github: https://github.com/charliecornwallis/Rfunctions/blob/master/MCMCglmmProc.R)
SItablesXL<-MCMCglmmProc(model=M1,pvalues="all",link="poisson",start_row=1,workbook=SItablesXL,create_sheet="yes",sheet="Table S1",title="Table S1: Jack project", fixed_names=c("Fission or Budding"),
fixed_diffinc = c("all"),
Include_random = "yes",
randomvar_names=c("Residual"),
variances=c("units"),padding=3)

#The output is in excel format and can be written to excel using the openxlsx package

#Can also be converted to Rmd friendly format
#function for extracting df from xl workbook
xl_2_df = function(xltab,sheet=NULL){
  df<-readWorkbook(xltab,sheet=sheet)
colnames(df)<-df[1,]
df<-df %>% filter(pMCMC != "" & row_number() != 1)
rownames(df)<-NULL
return(df)
}

S1<-xl_2_df(xltab=SItablesXL,sheet="Table S1")
md_table(S1)

```

**Do organisms that reproduce by fission have more cells?**
Fissiparous organisms appear to be larger (makes sense, trees, fungi, algae, etc)

*priors*: p1=list(R = list(V = 1, nu=0.002)) #sets prior for residual variance, the defaults are used as priors for fixed effects (see MCMCglmm course notes)

### **Model 2**: Fission vs Cell Types

*priors* p1=list(R = list(V = 1, nu=0.002))

```{r Model2Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 2: Cell Types vs Fission** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between fissioning and non-fissioning organisms, bar represents 90% and 95% credible intervals. "}
Model2 <- readRDS('RScripts/model_outputs/Model2.RDS')

Model2Sol_mcmc<- mcmc.list(lapply(Model2, function(m) m$Sol))
Model2Sol_gg<- ggmcmc::ggs(Model2Sol_mcmc)
Model2Sol_traceplot <- ggmcmc::ggs_traceplot(Model2Sol_gg) + theme_minimal()
Model2Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model2Sol_gg) + theme_minimal()
Model2SolGelman<- gelman.diag(Model2Sol_mcmc,multivariate = FALSE)


NoFission<- Model2Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species0') %>% 
  rename(Fission0 = value) %>% select(-Parameter)

Fission<- Model2Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species1') %>%
  rename(Fission1 = value) %>% select(-Parameter)

Difference<- merge(Fission, NoFission) %>%
  mutate(Difference = Fission1 - Fission0)


HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model2MeanPlot<- ggarrange(Model2Sol_traceplot, Model2Sol_caterpillar, DifPlotM, labels = "AUTO")
Model2MeanPlot


```


**Do organisms that reproduce by fission have more cell types?**
HCI overlaps with zero, so doesn't seem likely.

### **Model 3**: Germline vs Cell Numbers

Should we subset to only those organisms that have sterile cells for the germline models?

```{r Model3Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 3: Cell number vs Germline** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between early germline segregators and organisms that segregate germlines continuously as adults, bar represents 90% and 95% credible intervals. "}
Model3 <- readRDS('RScripts/model_outputs/Model3.RDS')

Model3Sol_mcmc<- mcmc.list(lapply(Model3, function(m) m$Sol))
Model3Sol_gg<- ggmcmc::ggs(Model3Sol_mcmc)
Model3Sol_traceplot <- ggmcmc::ggs_traceplot(Model3Sol_gg) + theme_minimal()
Model3Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model3Sol_gg) + theme_minimal()
Model3SolGelman<- gelman.diag(Model3Sol_mcmc,multivariate = FALSE)

GermlineAdult<- Model3Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleadult') %>% 
  rename(Adult = value) %>% select(-Parameter)

GermlineEarly<- Model3Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleearly') %>%
  rename(Early = value) %>% select(-Parameter)

Difference<- merge(GermlineEarly, GermlineAdult) %>%
  mutate(Difference = Early - Adult)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model3MeanPlot<- ggarrange(Model3Sol_traceplot, Model3Sol_caterpillar, DifPlotM, labels = "AUTO")
Model3MeanPlot
```

**Do organisms with early segregating germline have more cells?**
HCI just about overlaps with 0, so maayyyybe, but not clear. 

*priors* p1=list(R = list(V = 1, nu=0.002))


### **Model 4**: Germline vs Cell Types


```{r Model4Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 4: Cell Types vs Germline** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between early germline segregators and organisms that segregate germlines continuously as adults, bar represents 90% and 95% credible intervals. "}
Model4 <- readRDS('RScripts/model_outputs/Model4.RDS')

Model4Sol_mcmc<- mcmc.list(lapply(Model4, function(m) m$Sol))
Model4Sol_gg<- ggmcmc::ggs(Model4Sol_mcmc)
Model4Sol_traceplot <- ggmcmc::ggs_traceplot(Model4Sol_gg) + theme_minimal()
Model4Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model4Sol_gg) + theme_minimal()
Model4SolGelman<- gelman.diag(Model4Sol_mcmc,multivariate = FALSE)

GermlineAdult<- Model4Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleadult') %>% 
  rename(Adult = value) %>% select(-Parameter)

GermlineEarly<- Model4Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleearly') %>%
  rename(Early = value) %>% select(-Parameter)

Difference<- merge(GermlineEarly, GermlineAdult) %>%
  mutate(Difference = Early - Adult)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model4MeanPlot<- ggarrange(Model4Sol_traceplot, Model4Sol_caterpillar, DifPlotM, labels = "AUTO")
Model4MeanPlot
```

**Do organisms that segregate germline early have more cell types?**
Again, just about overlaps with 0, so not clear. 

p1=list(R = list(V = 1, nu=0.002))


## Phylogenetically Informed Models

Models below here use inverse covariance matrix describing the relationships among species to control for phylogeny. 

### **Model 5**: Fission vs Cell Number
        
        
```{r Model5Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 5: Cell Number vs Fission with phylogeny ** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between fissioning and non-fissioning organisms, bar represents 90% and 95% credible intervals. "}
Model5 <- readRDS('RScripts/model_outputs/Model5.RDS')
Model5Sol_mcmc<- mcmc.list(lapply(Model5, function(m) m$Sol))
Model5Sol_gg<- ggmcmc::ggs(Model5Sol_mcmc)
Model5Sol_ggSubset<- subset(Model5Sol_gg,  grepl('FissionOrBuddingObserved_Species', Model5Sol_gg$Parameter)) #need to subset so we don't get a plot for each species

Model5Sol_traceplot <- ggmcmc::ggs_traceplot(Model5Sol_ggSubset) + theme_minimal()


Model5Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model5Sol_ggSubset) + theme_minimal()


Model5SolGelman<- gelman.diag(Model5Sol_mcmc,multivariate = FALSE)

NoFission<- Model5Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species0') %>% 
  rename(Fission0 = value) %>% select(-Parameter)

Fission<- Model5Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species1') %>%
  rename(Fission1 = value) %>% select(-Parameter)

Difference<- merge(Fission, NoFission) %>%
  mutate(Difference = Fission1 - Fission0)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model5MeanPlot<- ggarrange(Model5Sol_traceplot, Model5Sol_caterpillar, DifPlotM, labels = "AUTO")
Model5MeanPlot
```

Again, just about overlaps with 0, so not clear. 

p2=list(R = list(V = 1, nu=0.002), 
        G = list(G1=list(V=1, nu=0.002)))

### **Model 6**: Fission vs Cell Types


```{r Model6Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 6: Cell Number vs Fission with phylogeny ** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between fissioning and non-fissioning organisms, bar represents 90% and 95% credible intervals. "}
Model6 <- readRDS('RScripts/model_outputs/Model6.RDS')
Model6Sol_mcmc<- mcmc.list(lapply(Model6, function(m) m$Sol))
Model6Sol_gg<- ggmcmc::ggs(Model6Sol_mcmc)


Model6Sol_ggSubset<- subset(Model6Sol_gg,  grepl('FissionOrBuddingObserved_Species', Model6Sol_gg$Parameter)) #need to subset so we don't get a plot for each species

Model6Sol_traceplot <- ggmcmc::ggs_traceplot(Model6Sol_ggSubset) + theme_minimal()


Model6Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model6Sol_ggSubset) + theme_minimal()


Model6SolGelman<- gelman.diag(Model6Sol_mcmc,multivariate = FALSE)

NoFission<- Model6Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species0') %>% 
  rename(Fission0 = value) %>% select(-Parameter)

Fission<- Model6Sol_gg %>%
  filter(Parameter == 'FissionOrBuddingObserved_Species1') %>%
  rename(Fission1 = value) %>% select(-Parameter)

Difference<- merge(Fission, NoFission) %>%
  mutate(Difference = Fission1 - Fission0)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model6MeanPlot<- ggarrange(Model6Sol_traceplot, Model6Sol_caterpillar, DifPlotM, labels = "AUTO")
Model6MeanPlot
```

Overlaps with 0, no difference

p2=list(R = list(V = 1, nu=0.002), 
        G = list(G1=list(V=1, nu=0.002)))

### **Model 7**: Germline vs Cell Number

```{r Model7Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 7: Cell Number vs Fission with phylogeny ** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences  between early germline segregators and organisms that segregate germlines continuously as adults, bar represents 90% and 95% credible intervals. "}
Model7 <- readRDS('RScripts/model_outputs/Model7.RDS')
Model7Sol_mcmc<- mcmc.list(lapply(Model7, function(m) m$Sol))
Model7Sol_gg<- ggmcmc::ggs(Model7Sol_mcmc)


Model7Sol_ggSubset<- subset(Model7Sol_gg,  grepl('germline_timing_simple', Model7Sol_gg$Parameter)) #need to subset so we don't get a plot for each species

Model7Sol_traceplot <- ggmcmc::ggs_traceplot(Model7Sol_ggSubset) + theme_minimal()


Model7Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model7Sol_ggSubset) + theme_minimal()


Model7SolGelman<- gelman.diag(Model7Sol_mcmc,multivariate = FALSE)


GermlineAdult<- Model7Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleadult') %>% 
  rename(Adult = value) %>% select(-Parameter)

GermlineEarly<- Model7Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleearly') %>%
  rename(Early = value) %>% select(-Parameter)

Difference<- merge(GermlineEarly, GermlineAdult) %>%
  mutate(Difference = Early - Adult)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)


Model7MeanPlot<- ggarrange(Model7Sol_traceplot, Model7Sol_caterpillar, DifPlotM, labels = "AUTO")
Model7MeanPlot
```

Things with a germline might be smaller: the 95% CI is *just* below 0 (-0.34)

p2=list(R = list(V = 1, nu=0.002), 
        G = list(G1=list(V=1, nu=0.002)))

### **Model 8**: Germline vs Cell Types


```{r Model8Mean, include = T, fig.height = 8, echo = F, fig.cap = "**Model 8: Cell Number vs Fission with phylogeny ** *A* Traceplots for the estimated means, *B* Estimates for means from posterior distribution, dots represent median, thick and thin lines indicate 90% and 95% of highest posterior density regions, respectively. *C* Density plot of estimated differences between early germline segregators and organisms that segregate germlines continuously as adults, bar represents 90% and 95% credible intervals. "}
Model8 <- readRDS('RScripts/model_outputs/Model8.RDS')
Model8Sol_mcmc<- coda::mcmc.list(lapply(Model8, function(m) m$Sol))
summary(Model8$chain1)

Model8Sol_gg<- ggmcmc::ggs(Model8Sol_mcmc)
Model8Sol_ggSubset<- subset(Model8Sol_gg,  grepl('germline_timing_simple', Model8Sol_gg$Parameter)) #need to subset so we don't get a plot for each species
Model8Sol_traceplot <- ggmcmc::ggs_traceplot(Model8Sol_ggSubset) + theme_minimal()
Model8Sol_caterpillar<- ggmcmc::ggs_caterpillar(Model8Sol_ggSubset) + theme_minimal()
Model8SolGelman<- coda::gelman.diag(Model8Sol_mcmc,multivariate = FALSE)

GermlineAdult<- Model8Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleadult') %>% 
  rename(Adult = value) %>% select(-Parameter)

GermlineEarly<- Model8Sol_gg %>%
  filter(Parameter == 'germline_timing_simpleearly') %>%
  rename(Early = value) %>% select(-Parameter)

Difference<- merge(GermlineEarly, GermlineAdult) %>%
  mutate(Difference = Early - Adult)

HDI_90<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.90)
HDI_95<- bayestestR::ci(Difference$Difference, method = 'HDI', ci = 0.95)

DifPlotM<- ggplot(Difference, aes(colour = as.factor(Chain), x = Difference)) + geom_density() + theme_minimal() + geom_segment(x = HDI_90$CI_low, y = 0, xend = HDI_90$CI_high, yend = 0, colour = 'grey', size = 4) + geom_segment(x = HDI_95$CI_low, y = 0, xend = HDI_95$CI_high, yend = 0, colour = 'grey', size = 1)

Model8MeanPlot<- ggarrange(Model8Sol_traceplot, Model8Sol_caterpillar, DifPlotM, labels = "AUTO")
Model8MeanPlot

```

Seems like they may be smaller, but that they have more cell types per cell-- HCI is just above 0 (`r HDI_95$CI_low`).

p2=list(R = list(V = 1, nu=0.002), 
        G = list(G1=list(V=1, nu=0.002)))


Is pMCMC just the number of simulated cases where difference is <0? In which case:

```{r}
Difference %>%
  summarise(over_0 = sum(Difference > 0), under_0 = sum(Difference <=0), proportion = under_0/(over_0 + under_0))

```

## Open Questions

Phylogenetic correlation between germline and fission-- multivariate model? How to test this?

```{r}
ModelMulti <- readRDS('RScripts/model_outputs/Model8.RDS')
#Univariate regression is covariance between response and predictor/variance in predictor
ModelMulti_VCV<- mcmc.list(lapply(ModelMulti, function(m) m$VCV))
plot(ModelMulti_VCV) 
gelman.diag(ModelMulti_VCV,multivariate = FALSE)

ModelMulti_VCV_gg<- ggmcmc::ggs(ModelMulti_VCV)

# for between species use the parameters ending in species 
Covariance<- ModelMulti_VCV_gg %>%
  filter(Parameter == 'traitFissionBinary.1:traitEarlyGermlineBinary.1.species') %>% 
  rename(Covariance = value) %>% select(-Parameter)

VariancePredictor<- ModelMulti_VCV_gg %>%
  filter(Parameter == 'traitFissionBinary.1:traitFissionBinary.1.species') %>%
  rename(PredictorVariance = value) %>% select(-Parameter)

Regression<- merge(Covariance, VariancePredictor) %>%
  mutate(value = Covariance / PredictorVariance)
glimpse(Regression)
ggplot(Regression, aes(x = Iteration, y = value, colour = as.factor(Chain))) + geom_line(size = 1, alpha = 0.5) + geom_smooth() + theme_minimal()


```

\newpage

# References

